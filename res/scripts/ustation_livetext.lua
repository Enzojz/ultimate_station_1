local pipe = require "ustation/pipe"
local func = require "ustation/func"
local coor = require "ustation/coor"

local abc = {
   [32] = {a = 0, b = 1, c = 19},
   [33] = {a = 5, b = 11, c = 6},
   [34] = {a = 5, b = 20, c = 5},
   [35] = {a = 2, b = 43, c = 1},
   [36] = {a = 4, b = 38, c = 4},
   [37] = {a = 3, b = 58, c = 3},
   [38] = {a = 3, b = 54, c = 0},
   [39] = {a = 5, b = 7, c = 4},
   [40] = {a = 3, b = 16, c = 2},
   [41] = {a = 2, b = 16, c = 3},
   [42] = {a = 5, b = 24, c = 5},
   [43] = {a = 4, b = 39, c = 3},
   [44] = {a = 4, b = 10, c = 4},
   [45] = {a = 5, b = 20, c = 5},
   [46] = {a = 4, b = 11, c = 4},
   [47] = {a = 2, b = 32, c = 2},
   [48] = {a = 2, b = 42, c = 2},
   [49] = {a = 6, b = 35, c = 5},
   [50] = {a = 3, b = 39, c = 4},
   [51] = {a = 3, b = 39, c = 4},
   [52] = {a = 1, b = 44, c = 1},
   [53] = {a = 4, b = 37, c = 5},
   [54] = {a = 4, b = 39, c = 3},
   [55] = {a = 4, b = 40, c = 2},
   [56] = {a = 3, b = 40, c = 3},
   [57] = {a = 4, b = 38, c = 4},
   [58] = {a = 5, b = 10, c = 5},
   [59] = {a = 5, b = 11, c = 5},
   [60] = {a = 6, b = 32, c = 8},
   [61] = {a = 6, b = 35, c = 5},
   [62] = {a = 9, b = 31, c = 6},
   [63] = {a = 3, b = 30, c = 3},
   [64] = {a = 4, b = 60, c = 3},
   [65] = {a = 0, b = 54, c = 0},
   [66] = {a = 7, b = 41, c = 4},
   [67] = {a = 3, b = 49, c = 1},
   [68] = {a = 7, b = 50, c = 4},
   [69] = {a = 7, b = 36, c = 3},
   [70] = {a = 7, b = 36, c = 2},
   [71] = {a = 3, b = 51, c = 4},
   [72] = {a = 7, b = 47, c = 7},
   [73] = {a = 7, b = 8, c = 7},
   [74] = {a = 1, b = 26, c = 7},
   [75] = {a = 7, b = 46, c = 0},
   [76] = {a = 7, b = 33, c = 1},
   [77] = {a = 7, b = 60, c = 7},
   [78] = {a = 7, b = 47, c = 7},
   [79] = {a = 3, b = 58, c = 3},
   [80] = {a = 7, b = 39, c = 2},
   [81] = {a = 3, b = 60, c = 1},
   [82] = {a = 7, b = 43, c = 0},
   [83] = {a = 2, b = 38, c = 3},
   [84] = {a = 1, b = 45, c = 1},
   [85] = {a = 6, b = 47, c = 6},
   [86] = {a = 0, b = 54, c = 0},
   [87] = {a = 1, b = 81, c = 1},
   [88] = {a = 0, b = 51, c = 1},
   [89] = {a = 0, b = 50, c = 0},
   [90] = {a = 2, b = 44, c = 2},
   [91] = {a = 7, b = 15, c = 2},
   [92] = {a = 2, b = 32, c = 2},
   [93] = {a = 2, b = 16, c = 6},
   [94] = {a = 5, b = 37, c = 4},
   [95] = {a = 2, b = 33, c = 2},
   [96] = {a = 5, b = 17, c = 10},
   [97] = {a = 2, b = 33, c = 5},
   [98] = {a = 5, b = 37, c = 3},
   [99] = {a = 3, b = 34, c = 1},
   [100] = {a = 3, b = 37, c = 5},
   [101] = {a = 3, b = 37, c = 2},
   [102] = {a = 1, b = 27, c = 0},
   [103] = {a = 2, b = 38, c = 2},
   [104] = {a = 5, b = 35, c = 5},
   [105] = {a = 4, b = 11, c = 4},
   [106] = {a = -3, b = 18, c = 4},
   [107] = {a = 5, b = 36, c = 0},
   [108] = {a = 5, b = 8, c = 6},
   [109] = {a = 5, b = 56, c = 5},
   [110] = {a = 5, b = 35, c = 5},
   [111] = {a = 3, b = 39, c = 3},
   [112] = {a = 5, b = 37, c = 3},
   [113] = {a = 3, b = 37, c = 5},
   [114] = {a = 5, b = 24, c = 0},
   [115] = {a = 2, b = 30, c = 3},
   [116] = {a = 1, b = 27, c = 1},
   [117] = {a = 5, b = 34, c = 6},
   [118] = {a = 1, b = 40, c = 0},
   [119] = {a = 1, b = 61, c = 1},
   [120] = {a = 1, b = 38, c = 1},
   [121] = {a = 0, b = 41, c = 0},
   [122] = {a = 2, b = 32, c = 2},
   [123] = {a = 2, b = 20, c = 2},
   [124] = {a = 7, b = 6, c = 7},
   [125] = {a = 2, b = 20, c = 2},
   [126] = {a = 4, b = 38, c = 4},
   [127] = {a = 0, b = 1, c = 39}
}
local kern = {
   [32] = {
      {[65] = "-4"},
      {[76] = "-3"},
      {[80] = "-1"},
      {[84] = "-1"},
      {[89] = "-1"}
   },
   [44] = {
      {[70] = "-9"},
      {[80] = "-10"},
      {[84] = "-9"},
      {[86] = "-7"},
      {[87] = "-4"},
      {[89] = "-10"},
      {[114] = "-4"},
      {[118] = "-6"},
      {[119] = "-4"},
      {[121] = "-6"}
   },
   [45] = {
      {[84] = "-4"},
      {[86] = "-4"},
      {[87] = "-1"},
      {[89] = "-7"}
   },
   [46] = {
      {[70] = "-9"},
      {[80] = "-10"},
      {[84] = "-9"},
      {[86] = "-7"},
      {[87] = "-4"},
      {[89] = "-10"},
      {[114] = "-4"},
      {[118] = "-6"},
      {[119] = "-4"},
      {[121] = "-6"}
   },
   [49] = {
      {[49] = "-6"}
   },
   [58] = {
      {[84] = "-9"},
      {[86] = "-3"},
      {[87] = "-1"},
      {[89] = "-4"}
   },
   [65] = {
      {[32] = "-4"},
      {[70] = "-4"},
      {[80] = "-6"},
      {[84] = "-6"},
      {[86] = "-6"},
      {[87] = "-3"},
      {[89] = "-6"}
   },
   [79] = {
      {[84] = "-1"}
   },
   [84] = {
      {[32] = "-1"},
      {[65] = "-6"},
      {[76] = "-6"},
      {[82] = "-1"}
   },
   [86] = {
      {[65] = "-6"},
      {[76] = "-6"},
      {[82] = "-1"}
   },
   [87] = {
      {[65] = "-3"},
      {[76] = "-6"},
      {[82] = "-1"}
   },
   [89] = {
      {[32] = "-1"},
      {[65] = "-6"},
      {[76] = "-6"},
      {[82] = "-1"}
   },
   [97] = {
      {[84] = "-9"},
      {[86] = "-6"},
      {[87] = "-3"},
      {[89] = "-6"}
   },
   [99] = {
      {[84] = "-9"}
   },
   [101] = {
      {[84] = "-9"},
      {[86] = "-4"},
      {[87] = "-1"},
      {[89] = "-7"}
   },
   [102] = {
      {[102] = "-1"}
   },
   [105] = {
      {[84] = "-3"},
      {[86] = "-1"},
      {[87] = "0"},
      {[89] = "-3"}
   },
   [111] = {
      {[84] = "-9"},
      {[86] = "-4"},
      {[87] = "-1"},
      {[89] = "-7"}
   },
   [112] = {
      {[89] = "-6"}
   },
   [113] = {
      {[89] = "-7"}
   },
   [114] = {
      {[84] = "-3"},
      {[86] = "-3"},
      {[87] = "-1"}
   },
   [115] = {
      {[84] = "-9"}
   },
   [117] = {
      {[84] = "-3"},
      {[86] = "-3"},
      {[87] = "-1"},
      {[89] = "-4"}
   },
   [118] = {
      {[65] = "-1"},
      {[89] = "-4"}
   },
   [119] = {
      {[65] = "-1"},
      {[84] = "-4"}
   },
   [121] = {
      {[65] = "-1"},
      {[76] = "-3"},
      {[84] = "-4"},
      {[86] = "-3"},
      {[87] = "-1"}
   }
}

local gen = function(scale, z)
    local scale = scale or 1
    local z = z or 0
    return function(text)
        local result = pipe.new 
        * { text:byte(1, -1) }
        * pipe.fold(pipe.new, 
        function(r, c)
            local lastPos = #r > 0 and r[#r].to or 0
            local abc = abc[c]
            local kern = kern[c]
            local pos = lastPos + abc.a + (#r > 0 and kern and kern[r[#r].c] or 0)
            local nextPos = pos + abc.b + abc.c
            return r / {c = c, from = pos, to = nextPos}
        end)

        return 
            function(transf) return func.map(result, function(r)
                return {
                    id = "livetext/lato/" .. tostring(r.c) .. ".mdl",
                    transf = coor.transX(r.from * 0.01) * coor.transZ(z * 0.1) * coor.scale(coor.xyz(scale, scale, scale)) * (transf or coor.I())
                }
            end)
        end, result[#result].to * scale * 0.01
    end
end

return gen